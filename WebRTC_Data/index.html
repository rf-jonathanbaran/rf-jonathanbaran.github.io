<html>
<head>
<script type="text/javascript" src="../js/jquery.js"></script>
<script type="text/javascript" src="../js/peerAdapter.js"></script>
<script type="text/javascript" src="../js/glMatrix.js"></script>
<script type="text/javascript" src="gameGL.js"></script>
<script type="text/javascript" src="../js/WebRTC.js"></script>
<script type='text/javascript' src='https://cdn.firebase.com/js/client/1.0.6/firebase.js'></script>

</head>
<body>
	<div id="rtc">
		<input type='button' value='Create Offer' id='btnOffer' /> <input
			type='button' value='Create Answer' id='btnAnswer' />
	</div>
	<div id="webgl" style='display: none'>
		<canvas id="canvas" width=640 height=480 style='background: #000033'></canvas>
	</div>
<script type="text/javascript">
"use strict";
var PeerConOffer = null;
var PeerConAnswer = null;

var myOffer = new Firebase('https://brickmii-signal.firebaseIO.com/webrtc/offer');
var myAnswer = new Firebase('https://brickmii-signal.firebaseIO.com/webrtc/answer');


function createOfferComplete(obj) {
  Firebase.goOnline();
  myOffer.set(null);
  myAnswer.set(null);
  myOffer.set(JSON.stringify(obj));
  myAnswer.on('value', function(snapshot) {
    if(snapshot.val()) {
      acceptAnswer(JSON.parse(snapshot.val()));
      myOffer.set(null);
      myAnswer.set(null);
      Firebase.goOffline()
    }
   });
}

function createAnswerComplete(obj) {
  myAnswer.set(JSON.stringify(obj));
  Firebase.goOffline();
}

function createOffer() {
  if(PeerConOffer == null) {
    PeerConOffer = new WebRTC_OfferConnection();
  }
  PeerConOffer.onsessionready = createOfferComplete;
  PeerConOffer.onconnect = connected;
  PeerConOffer.createOffer();
}

function createAnswer(obj) {
  if(PeerConAnswer == null) {
    PeerConAnswer = new WebRTC_AnswerConnection();
  }
  PeerConAnswer.onsessionready = createAnswerComplete;
  PeerConAnswer.onconnect = connected;
  PeerConAnswer.createAnswer(obj);
}

function acceptAnswer(obj) {
  PeerConOffer.acceptAnswer(obj);
}

function queryOffer() {
  Firebase.goOnline();
  myOffer.on('value', function(snapshot) {
    if(snapshot.val()){
      createAnswer(JSON.parse(snapshot.val()));
      myOffer.set(null);
    }
  });
}

function connected() {
	$("#rtc").hide();
	$("#webgl").show();
	setupGame(document.getElementById("canvas"), PeerConOffer?PeerConOffer:PeerConAnswer);
}

$(function() {
  Firebase.goOffline();
  $('#btnOffer').click(createOffer);
  $('#btnAnswer').click(queryOffer);
  
  PeerConAnswer = new WebRTC_AnswerConnection();
  connected();
});
</script>
</body>
</html>
